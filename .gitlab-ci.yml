# ------------------------------------------------------------
# GitLab CI 配置文件 - 文档部署
#
# 功能特性：
# - Storybook 文档构建与部署
# - VitePress 文档构建与部署
# - 支持 GitLab Pages 自动部署
# ------------------------------------------------------------

stages:
  - install
  - build_docs
  - deploy_docs

# 全局变量配置
variables:
  PUBLIC_DIR: public
  STORYBOOK_DIR: dist/storybook
  DOCS_DIR: dist/docs
  DOCKER_BUILD_IMAGE: node:22-alpine

# 全局缓存配置
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store/
    - node_modules/

# ============================
# 安装依赖
# ============================

install:
  stage: install
  image: $DOCKER_BUILD_IMAGE
  before_script:
    - npm install -g pnpm@10.14.0
  script:
    - pnpm install --frozen-lockfile
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    policy: pull-push
    paths:
      - .pnpm-store/
      - node_modules/
      - packages/*/node_modules/
  artifacts:
    paths:
      - node_modules/
      - packages/*/node_modules/
    expire_in: 1 week
  only:
    - master
    - /^release\/.+$/

# ============================
# 文档构建
# ============================

# 构建 Storybook
build:storybook:
  stage: build_docs
  image: $DOCKER_BUILD_IMAGE
  dependencies:
    - install
  before_script:
    - npm install -g pnpm@10.14.0
  script:
    - pnpm storybook:build
  artifacts:
    paths:
      - $STORYBOOK_DIR
    expire_in: 1 week
  only:
    - master
    - /^release\/.+$/

# 构建 VitePress 文档
build:docs:
  stage: build_docs
  image: $DOCKER_BUILD_IMAGE
  dependencies:
    - install
  before_script:
    - apk add --no-cache git
    - npm install -g pnpm@10.14.0
  script:
    - pnpm docs:build
  artifacts:
    paths:
      - $DOCS_DIR
    expire_in: 1 week
  only:
    - master
    - /^release\/.+$/

# ============================
# 文档部署
# ============================

# 部署到 GitLab Pages (自动)
# 访问地址：
#   - Storybook: https://sunweijie1.gitlab.io/aix/storybook
#   - VitePress: https://sunweijie1.gitlab.io/aix/docs
pages:
  stage: deploy_docs
  dependencies:
    - build:storybook
    - build:docs
  script:
    - mkdir -p $PUBLIC_DIR
    - cp -r $STORYBOOK_DIR $PUBLIC_DIR/storybook
    - cp -r $DOCS_DIR $PUBLIC_DIR/docs
    - echo "✅ Storybook 已部署到 /storybook"
    - echo "✅ VitePress 已部署到 /docs"
  artifacts:
    paths:
      - $PUBLIC_DIR
    expire_in: 1 week
  only:
    - master
    - /^release\/.+$/
