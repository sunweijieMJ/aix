# ------------------------------------------------------------
# GitLab CI 配置文件 - 文档部署
#
# 功能特性：
# - Storybook 文档构建与部署
# - VitePress 文档构建与部署
# - 支持 GitLab Pages 自动部署
# - 支持独立服务器部署
# ------------------------------------------------------------

stages:
  - install
  - build_docs
  - deploy_docs

# 全局变量配置
variables:
  PUBLIC_DIR: public
  STORYBOOK_DIR: dist/storybook
  DOCS_DIR: dist/docs
  DOCKER_BUILD_IMAGE: node:22-alpine

# 全局工作流规则
workflow:
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^(master|release\/.+)$/
    - when: never

# 缓存依赖配置
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store/
    - node_modules/

# ============================
# 安装依赖
# ============================

install:
  stage: install
  tags: [trail]
  image: $DOCKER_BUILD_IMAGE
  script:
    - pnpm install --frozen-lockfile
  cache:
    policy: pull-push
    paths:
      - .pnpm-store/
      - node_modules/
      - packages/*/node_modules/
  artifacts:
    paths:
      - node_modules/
      - packages/*/node_modules/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^(master|release\/.+)$/
      when: always

# ============================
# 文档构建
# ============================

# 构建 Storybook
build:storybook:
  stage: build_docs
  tags: [trail]
  image: $DOCKER_BUILD_IMAGE
  dependencies: [install]
  script:
    - pnpm storybook:build
  artifacts:
    paths:
      - $STORYBOOK_DIR
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^(master|release\/.+)$/
      when: on_success

# 构建 VitePress 文档
build:docs:
  stage: build_docs
  tags: [trail]
  image: $DOCKER_BUILD_IMAGE
  dependencies: [install]
  script:
    - pnpm docs:build
  artifacts:
    paths:
      - $DOCS_DIR
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^(master|release\/.+)$/
      when: on_success

# ============================
# 文档部署
# ============================

# 部署到 GitLab Pages (自动)
pages:
  stage: deploy_docs
  tags: [trail]
  dependencies: [build:storybook]
  script:
    - mkdir -p $PUBLIC_DIR
    - cp -r $STORYBOOK_DIR $PUBLIC_DIR/storybook
  artifacts:
    paths:
      - $PUBLIC_DIR
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      when: on_success

# 部署 Storybook 到远程服务器 (手动)
deploy:storybook:
  stage: deploy_docs
  tags: [trail]
  dependencies: [build:storybook]
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $STORYBOOK_DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "部署 Storybook 到 $STORYBOOK_DEPLOY_SERVER"
    - rsync -avz --delete $STORYBOOK_DIR/ $STORYBOOK_DEPLOY_USER@$STORYBOOK_DEPLOY_SERVER:$STORYBOOK_DEPLOY_PATH/
  rules:
    - if: $CI_COMMIT_REF_NAME == "master" && $STORYBOOK_DEPLOY_SERVER != null
      when: manual
  needs: [build:storybook]

# 部署 VitePress 文档到远程服务器 (手动)
deploy:docs:
  stage: deploy_docs
  tags: [trail]
  dependencies: [build:docs]
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DOCS_DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "部署 VitePress 文档到 $DOCS_DEPLOY_SERVER"
    - rsync -avz --delete $DOCS_DIR/ $DOCS_DEPLOY_USER@$DOCS_DEPLOY_SERVER:$DOCS_DEPLOY_PATH/
  rules:
    - if: $CI_COMMIT_REF_NAME == "master" && $DOCS_DEPLOY_SERVER != null
      when: manual
  needs: [build:docs]
