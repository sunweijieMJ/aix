# ============================================
# GitLab CI/CD 配置
# ============================================

# 定义全局变量
variables:
  # Node.js 版本
  NODE_VERSION: '22'
  # pnpm 版本
  PNPM_VERSION: '8'
  # Docker 镜像
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: '/certs'
  # 缓存配置
  PNPM_CACHE_DIR: '.pnpm-store'

# 定义全局缓存
cache:
  key: '${CI_COMMIT_REF_SLUG}'
  paths:
    - .pnpm-store
    - node_modules

# 定义阶段
stages:
  - install # 安装依赖
  - validate # 代码质量检查
  - test # 测试
  - build # 构建
  - docs # 文档生成
  - deploy # 部署（可选）

# ============================================
# 安装依赖
# ============================================
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}-alpine
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - echo "Installing dependencies..."
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules
    expire_in: 1 hour
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# ============================================
# 代码质量检查
# ============================================
validate_type_check:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ['install_dependencies']
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - echo "Running TypeScript type check..."
    - pnpm run type-check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

validate_lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ['install_dependencies']
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - echo "Running ESLint check..."
    - pnpm run lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

validate_format:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ['install_dependencies']
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - echo "Running Prettier format check..."
    - pnpm run format
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# ============================================
# 测试
# ============================================
test_unit:
  stage: test
  image: node:${NODE_VERSION}-alpine
  needs: ['install_dependencies']
  services:
    - postgres:15-alpine
  variables:
    # PostgreSQL 配置
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    POSTGRES_HOST_AUTH_METHOD: trust
    # 应用配置
    NODE_ENV: test
    DB_TYPE: postgresql
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: test_db
    DB_USER: test_user
    DB_PASSWORD: test_password
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - echo "Running unit tests..."
    - pnpm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# ============================================
# 构建
# ============================================
build_application:
  stage: build
  image: node:${NODE_VERSION}-alpine
  needs:
    - job: validate_type_check
    - job: validate_lint
    - job: validate_format
    - job: test_unit
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - echo "Building application..."
    - pnpm run build
  artifacts:
    paths:
      - dist
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# ============================================
# 文档生成和更新
# ============================================
docs_generate_openapi:
  stage: docs
  image: node:${NODE_VERSION}-alpine
  needs: ['install_dependencies']
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    # 安装 git（用于提交）
    - apk add --no-cache git
  script:
    - echo "Generating OpenAPI documentation..."
    - pnpm run docs:generate

    # 检查是否有变更
    - |
      if git diff --quiet docs/openapi.yaml; then
        echo "✓ No changes in OpenAPI documentation"
      else
        echo "✓ OpenAPI documentation updated"

        # 配置 git
        git config --global user.email "gitlab-ci@yourdomain.com"
        git config --global user.name "GitLab CI"

        # 提交变更（仅在 master 或 develop 分支）
        if [ "$CI_COMMIT_BRANCH" = "master" ] || [ "$CI_COMMIT_BRANCH" = "develop" ]; then
          git add docs/openapi.yaml
          git commit -m "docs: update OpenAPI documentation [skip ci]"
          git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_BRANCH}
        fi
      fi
  artifacts:
    paths:
      - docs/openapi.yaml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
  # 允许失败（如果没有权限推送）
  allow_failure: true

# ============================================
# Docker 镜像构建（可选）
# ============================================
build_docker:
  stage: build
  image: docker:24-alpine
  services:
    - docker:24-dind
  needs:
    - job: build_application
  before_script:
    - docker info
  script:
    - echo "Building Docker image..."
    - |
      # 定义镜像标签
      export GIT_HASH=$(echo $CI_COMMIT_SHA | cut -c1-8)
      export IMAGE_TAG="${GIT_HASH}-amd64"
      export IMAGE_NAME="${CI_REGISTRY_IMAGE}:${IMAGE_TAG}"

      echo "Building image: ${IMAGE_NAME}"

      # 构建镜像
      docker build \
        --build-arg BASE_IMAGE=node:22-alpine \
        -t ${IMAGE_NAME} \
        -f Dockerfile \
        .

      # 如果配置了镜像仓库，推送镜像
      if [ -n "$CI_REGISTRY" ]; then
        echo "Logging in to registry..."
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

        echo "Pushing image to registry..."
        docker push ${IMAGE_NAME}

        # 如果是 master 分支，打 latest 标签
        if [ "$CI_COMMIT_BRANCH" = "master" ]; then
          docker tag ${IMAGE_NAME} ${CI_REGISTRY_IMAGE}:latest
          docker push ${CI_REGISTRY_IMAGE}:latest
        fi
      fi
  # 仅在有 Docker 注册表配置时运行
  rules:
    - if: '$CI_REGISTRY != null && ($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop")'
      when: on_success
    - when: never

# ============================================
# 部署到测试环境（示例）
# ============================================
deploy_staging:
  stage: deploy
  image: alpine:latest
  needs:
    - job: build_docker
      optional: true
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "Deploying to staging environment..."
    - echo "This is a placeholder for deployment script"
    # 添加你的部署脚本，例如：
    # - ssh user@staging-server "docker pull ${IMAGE_NAME} && docker-compose up -d"
  environment:
    name: staging
    url: https://staging.yourdomain.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual

deploy_production:
  stage: deploy
  image: alpine:latest
  needs:
    - job: build_docker
      optional: true
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "Deploying to production environment..."
    - echo "This is a placeholder for deployment script"
    # 添加你的部署脚本
  environment:
    name: production
    url: https://yourdomain.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: manual
