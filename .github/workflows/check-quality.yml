# ------------------------------------------------------------
# GitHub Actions - CI 质量门禁
#
# 执行顺序：
# 1. build: 全量构建验证 + 缓存构建产物
# 2. test: 单元测试（并行执行）
# 3. type-check: TypeScript 类型检查（并行执行）
# 4. lint: 代码规范检查（并行执行）
#
# 触发条件：
# - PR 提交到 master / release/** 分支
# - 直接 push 到 master / release/** 分支
# ------------------------------------------------------------

name: Check Quality

on:
  pull_request:
    branches: [master, 'release/**']
  push:
    branches: [master, 'release/**']

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================
  # Build - 构建验证（首先执行）
  # ============================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Verify build outputs
        run: |
          echo "Checking build outputs..."
          failed=0
          for dir in packages/*/; do
            pkg=$(basename "$dir")
            # 跳过隐藏目录和非目录文件
            if [[ "$pkg" == .* ]] || [[ ! -d "$dir" ]]; then
              continue
            fi

            # 检查是否有构建产物 (es/lib/dist 任一存在即可)
            if [ -d "packages/$pkg/es" ] || [ -d "packages/$pkg/lib" ] || [ -d "packages/$pkg/dist" ]; then
              echo "✅ @aix/$pkg - build output exists"
            else
              # 检查是否有 build 脚本
              if grep -q '"build"' "packages/$pkg/package.json" 2>/dev/null; then
                echo "❌ @aix/$pkg - has build script but missing output"
                failed=1
              else
                echo "⚠️  @aix/$pkg - no build script (skip)"
              fi
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "Build verification failed"
            exit 1
          fi
          echo "All packages built successfully"

      # 缓存构建产物供后续 jobs 使用（node_modules 由各 job 通过 pnpm store 缓存自行恢复）
      - name: Cache build outputs
        uses: actions/cache/save@v5
        with:
          path: |
            packages/*/es
            packages/*/lib
            packages/*/dist
            internal/*/dist
          key: build-${{ github.sha }}

  # ============================
  # Test - 单元测试
  # ============================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # 恢复构建产物（node_modules 由 setup-node 的 pnpm store 缓存 + install 处理）
      - name: Restore build cache
        id: cache-restore
        uses: actions/cache/restore@v5
        with:
          path: |
            packages/*/es
            packages/*/lib
            packages/*/dist
            internal/*/dist
          key: build-${{ github.sha }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages (fallback)
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: pnpm build

      - name: Run tests
        run: pnpm test

  # ============================
  # Type Check - TypeScript 类型检查
  # ============================
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # 恢复构建产物（node_modules 由 setup-node 的 pnpm store 缓存 + install 处理）
      - name: Restore build cache
        id: cache-restore
        uses: actions/cache/restore@v5
        with:
          path: |
            packages/*/es
            packages/*/lib
            packages/*/dist
            internal/*/dist
          key: build-${{ github.sha }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages (fallback)
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: pnpm build

      - name: TypeScript type check
        run: pnpm type-check

  # ============================
  # Lint - 代码规范检查
  # ============================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # 恢复构建产物（node_modules 由 setup-node 的 pnpm store 缓存 + install 处理）
      - name: Restore build cache
        id: cache-restore
        uses: actions/cache/restore@v5
        with:
          path: |
            packages/*/es
            packages/*/lib
            packages/*/dist
            internal/*/dist
          key: build-${{ github.sha }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages (fallback)
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: pnpm build

      - name: Lint (ESLint + Stylelint)
        run: pnpm lint
